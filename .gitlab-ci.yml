image: maven:3.9.10-eclipse-temurin-24

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository" # absolute path to local repository, will be used to installe xternal libs
  SPRING_PROFILES_ACTIVE: test

stages:          # List of stages for jobs, and their order of execution
  - build
  - test
  - package
  - image
  - integration-test

cache:            # jobs that use the same cache don’t have to download the files again
  paths:
    - .m2/repository
  key: "$CI_COMMIT_REF_SLUG" # all commits from the same branch will share the cache

# build du projet
build-job:
  stage: build
  script:
    - |
      mvn -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository \
      -Dspring.profiles.active=test \
      -Dspring.datasource.username=$DATABASE_USERNAME \
      -Dspring.datasource.password=$DATABASE_PASSWORD \
      -Ddatabase.driver=$DATABASE_DRIVER \
      clean compile \
      --batch-mode --errors --fail-at-end --show-version

# tests unitaires
test-job:
  stage: test
  script:
    - mvn clean test

# création du JAR
package-job: 
  stage: package
  script:
    - mvn clean package --batch-mode --fail-at-end
  artifacts:
    paths:
      - target/*.jar
    name: "microservice-patient-jar-artifacts"

# build de l'image Docker
# le job tourne dans un conteneur avec Docker CLI
image-job: 
  stage: image
  image: docker:latest
  # récupérer le JAR issu du package-job
  dependencies:
  - package-job
  # fournit le daemon Docker qui exécute les conteneurs générés par les commandes des jobs
  services:
    - docker:dind
  # objectif : tester si le Dockerfile est correct / l’image peut être créée
  # echo pour transmettre le token Docker Hub au processus docker login
  before_script: echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script: 
    - docker build -t divineion/microservice-patient:$CI_COMMIT_REF_SLUG .
    - docker push divineion/microservice-patient:$CI_COMMIT_REF_SLUG

# lancer les tests d'intégration dans un container Docker
# récupérer l'image en se connectant à dockerhub
# tester si le conteneur peut démarrer (variables d'environnement etc)
integration-job: 
  services:
  - docker:dind
  stage: integration-test
  dependencies:
    - image-job
  before_script: echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script: 
# lancer le conteneur en mode détaché pour libérer le terminal et exécuter les tests avec Maven
    - |
      docker run -d --name patient-container --rm \
      -e SPRING_PROFILES_ACTIVE=test \
      -e SPRING_DATASOURCE_URL=$DATABASE_URL \
      -e DATABASE_DRIVER=$DATABASE_DRIVER \
      -e SPRING_DATASOURCE_USERNAME=$DATABASE_USERNAME \
      -e SPRING_DATASOURCE_PASSWORD=$DATABASE_PASSWORD \
      divineion/microservice-patient:$CI_COMMIT_REF_SLUG
    - docker ps
    - mvn clean verify
    - docker stop patient-container
  