image: maven:3.9.10-eclipse-temurin-24

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository" # absolute path to local repository, will be used to installe xternal libs
  SPRING_PROFILES_ACTIVE: test

stages:          # List of stages for jobs, and their order of execution
  - build
  - test
  - package
  - image

cache:            # jobs that use the same cache don’t have to download the files again
  paths:
    - .m2/repository
  key: "$CI_COMMIT_REF_SLUG" # all commits from the same branch will share the cache

# build du projet
build-job:
  stage: build
  script:
    - |
      mvn -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository \
      -Dspring.profiles.active=test \
      -Dspring.datasource.username=$DATABASE_USERNAME \
      -Dspring.datasource.password=$DATABASE_PASSWORD \
      -Ddatabase.driver=$DATABASE_DRIVER \
      clean compile \
      --batch-mode --errors --fail-at-end --show-version

# tests unitaires
test-job:
  stage: test
  script:
    - mvn clean test

# création du JAR
package-job: 
  stage: package
  script:
    - mvn clean package --batch-mode --fail-at-end
  artifacts:
    paths:
      - target/*.jar
    name: "microservice-patient-jar-artifacts"

# build de l'image Docker'
image-job: 
  stage: image
  image: docker:latest
  # récupérer le JAR issu du package-job
  dependencies:
  - package-job
  services:
    - docker:dind
  # tester si le Dockerfile est correct / l’image peut être créée
  # tester si le conteneur peut démarrer (variables d'environnement etc)
  # commande principale echo se termine immédiatement pour poursuivre le pipeline si pas d'erreur
  script: 
    - docker build -t microservice-patient:latest .
    - |
      docker run --rm \
      -e SPRING_PROFILES_ACTIVE=test \
      -e SPRING_DATASOURCE_URL=$DATABASE_URL \
      -e DATABASE_DRIVER=$DATABASE_DRIVER \
      -e SPRING_DATASOURCE_USERNAME=$DATABASE_USERNAME \
      -e SPRING_DATASOURCE_PASSWORD=$DATABASE_PASSWORD \
      microservice-patient:latest \
      /bin/bash -c 'echo "Container runs"'
